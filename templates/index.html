<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Fuel & Pacing Planner</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='fav-icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="RaceCraft Logo" class="header-logo">
                <div class="header-text">
                    <h1>RaceCraft</h1>
                    <h2 class="subtitle">Fuel & Pacing Planner</h2>
                    <p class="slogan">Build your perfect race.</p>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <!-- Left Panel: Inputs -->
            <div class="panel inputs-panel">
                <h2>Race Configuration</h2>

                <!-- GPX Upload -->
                <section class="input-section">
                    <h3>1. Upload Route (GPX)</h3>
                    <div class="file-upload">
                        <input type="file" id="gpx-file" accept=".gpx" />
                        <label for="gpx-file" class="file-label">
                            <span id="file-name">Choose GPX file...</span>
                        </label>
                    </div>
                    <div id="gpx-info" class="info-box" style="display: none;"></div>
                </section>

                <!-- Checkpoints -->
                <section class="input-section">
                    <h3>2. Checkpoints</h3>
                    <div class="input-group">
                        <label for="num-checkpoints">Number of Checkpoints:</label>
                        <input type="number" id="num-checkpoints" min="0" max="20" value="3" />
                    </div>
                    <div class="input-group">
                        <label for="avg-cp-time">
                            Avg CP Stop Time (minutes):
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Average time you expect to spend at each checkpoint for refueling, nutrition, and rest. This time is added to your total race time but not included in moving time calculations."></span>
                        </label>
                        <input type="number" id="avg-cp-time" min="0" step="0.5" value="5" />
                    </div>
                    <div id="checkpoint-distances"></div>
                </section>

                <!-- Terrain Difficulty -->
                <section class="input-section">
                    <h3>3. Terrain Difficulty</h3>
                    <div class="input-group checkbox-group">
                        <input type="checkbox" id="terrain-enabled" />
                        <label for="terrain-enabled">
                            Include Terrain Difficulty Adjustments
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Adjusts pace based on terrain type (road, trail, technical, etc.). Different terrain types have different speed multipliers. Your technical skill level determines how much these penalties are reduced."></span>
                        </label>
                    </div>
                    <div id="terrain-skill-container" style="display: none;">
                        <div class="input-group">
                            <label for="skill-level">
                                Technical Skill Level:
                                <span class="info-icon mdi mdi-information-outline" 
                                      tabindex="0"
                                      data-tooltip="Your ability to navigate technical terrain efficiently. Higher skill levels reduce terrain difficulty penalties. Novice runners experience full terrain slowdown, while Expert runners can maintain near-normal pace on technical trails."></span>
                            </label>
                            <select id="skill-level">
                                <option value="0.0">Novice (0% reduction)</option>
                                <option value="0.25">Beginner (25% reduction)</option>
                                <option value="0.5" selected>Intermediate (50% reduction)</option>
                                <option value="0.75">Advanced (75% reduction)</option>
                                <option value="1.0">Expert (100% reduction)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="default-terrain-type">
                                Default Terrain Type:
                                <span class="info-icon mdi mdi-information-outline" 
                                      tabindex="0"
                                      data-tooltip="Sets the terrain type for all segments at once. Each terrain type has a pace multiplier - smoother terrain is faster, technical terrain is slower. You can override individual segments later if needed."></span>
                            </label>
                            <select id="default-terrain-type">
                                <option value="">-- Select to apply to all --</option>
                                <option value="road">Road/Track (0.95Ã—)</option>
                                <option value="smooth_trail" selected>Smooth Trail (1.0Ã—)</option>
                                <option value="dirt_road">Dirt Road (1.05Ã—)</option>
                                <option value="rocky_runnable">Rocky Runnable (1.15Ã—)</option>
                                <option value="technical">Technical Trail (1.33Ã—)</option>
                                <option value="very_technical">Very Technical (1.65Ã—)</option>
                                <option value="scrambling">Scrambling (2.0Ã—)</option>
                            </select>
                        </div>
                        <div id="terrain-difficulties"></div>
                    </div>
                </section>

                <!-- Pacing -->
                <section class="input-section">
                    <h3>4. Pacing</h3>
                    <div class="input-group">
                        <label for="z2-pace-min">
                            Flat Terrain Pace
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Your expected average pace on flat terrain at a comfortable, sustainable effort level (Zone 2). This serves as the baseline for calculating pace adjustments based on elevation changes and terrain difficulty."></span>
                        </label>
                        <div class="pace-input">
                            <input type="number" id="z2-pace-min" min="3" max="20" value="6" />
                            <span>:</span>
                            <input type="number" id="z2-pace-sec" min="0" max="59" value="30" />
                            <span class="unit">min/km</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="climbing-ability">
                            Climbing Ability:
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Your vertical ascent rate capability. This determines how much climbing affects your pace on uphills. Conservative climbers slow down more on steep ascents, while elite climbers maintain better speed on climbs."></span>
                        </label>
                        <select id="climbing-ability">
                            <option value="conservative">Conservative Climber (600 m/h)</option>
                            <option value="moderate" selected>Moderate Climber (800 m/h)</option>
                            <option value="strong">Strong Climber (1000 m/h)</option>
                            <option value="very_strong">Very Strong Climber (1250 m/h)</option>
                            <option value="elite">Elite Climber (1500 m/h)</option>
                        </select>
                    </div>
                    <div class="input-group checkbox-group">
                        <input type="checkbox" id="fatigue-enabled" checked />
                        <label for="fatigue-enabled">
                            Include Fatigue Penalty
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="When enabled, your pace will gradually slow down as accumulated distance and elevation increase throughout the race, simulating the natural effects of physical fatigue. Disable this for fresh or well-rested segment predictions."></span>
                        </label>
                    </div>
                    <div class="input-group" id="fitness-level-group">
                        <label for="fitness-level">
                            Fitness Level:
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Your endurance fitness level determines how fatigue accumulates over the race distance. FOP (Fatigue Onset Point) indicates the distance where you start experiencing significant pace degradation. Higher fitness levels delay fatigue onset and reduce its impact."></span>
                        </label>
                        <select id="fitness-level">
                            <option value="untrained">Untrained (FOP: 20-30 km-effort)</option>
                            <option value="recreational" selected>Recreational (FOP: 30-45 km-effort)</option>
                            <option value="trained">Trained (FOP: 45-65 km-effort)</option>
                            <option value="elite">Elite (FOP: 65-85+ km-effort)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="race-start-time">Race Start Time (optional):</label>
                        <input type="time" id="race-start-time" />
                    </div>
                </section>

                <!-- Nutrition -->
                <section class="input-section">
                    <h3>5. Nutrition</h3>
                    <div class="input-group">
                        <label for="carbs-per-hour">Carbs per Hour (g):</label>
                        <input type="number" id="carbs-per-hour" min="0" step="5" value="60" />
                    </div>
                    <div class="input-group">
                        <label for="water-per-hour">Water per Hour (mL):</label>
                        <input type="number" id="water-per-hour" min="0" step="50" value="500" />
                    </div>
                </section>

                <!-- Actions -->
                <section class="actions">
                    <button id="calculate-btn" class="btn btn-primary">Calculate Race Plan</button>
                    <button id="save-btn" class="btn btn-secondary" disabled>Save Plan</button>
                    <button id="load-btn" class="btn btn-secondary">Load Plan</button>
                    <button id="export-btn" class="btn btn-secondary" disabled>Export CSV</button>
                    <button id="clear-btn" class="btn btn-danger">Clear & Start Again</button>
                </section>
            </div>

            <!-- Right Panel: Results -->
            <div class="panel results-panel">
                <h2>Race Plan</h2>
                
                <div id="results-container" style="display: none;">
                    <!-- Elevation Profile -->
                    <div class="elevation-chart-container">
                        <h3>Elevation Profile</h3>
                        <canvas id="elevation-chart"></canvas>
                    </div>
                    
                    <!-- Summary -->
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="card-label">Total Distance</div>
                            <div class="card-value" id="summary-distance">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Moving Time</div>
                            <div class="card-value" id="summary-moving-time">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">CP Time</div>
                            <div class="card-value" id="summary-cp-time">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Total Time</div>
                            <div class="card-value" id="summary-total-time">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Elevation Gain</div>
                            <div class="card-value" id="summary-elev-gain">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Total Carbs</div>
                            <div class="card-value" id="summary-carbs">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Total Water</div>
                            <div class="card-value" id="summary-water">--</div>
                        </div>
                    </div>

                    <!-- Segments Table -->
                    <div class="table-container">
                        <table id="segments-table">
                            <thead>
                                <tr>
                                    <th>Segment</th>
                                    <th>Dist (km)</th>
                                    <th>Elev +/-</th>
                                    <th>Net (m)</th>
                                    <th>Elev Pace</th>
                                    <th class="fatigue-col">Fatigue</th>
                                    <th class="terrain-col">Terrain</th>
                                    <th>Final Pace</th>
                                    <th>Time</th>
                                    <th>Carbs (g)</th>
                                    <th>Water (L)</th>
                                    <th>Cumul Time</th>
                                    <th class="time-of-day-col" id="time-header" style="display: none;">Time of Arrival</th>
                                </tr>
                            </thead>
                            <tbody id="segments-tbody">
                                <!-- Segments will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="no-results" class="placeholder">
                    <p>ðŸ‘† Configure your race and click "Calculate Race Plan" to see results</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Plan Modal -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h2>Save Race Plan</h2>
            <div class="input-group">
                <label for="plan-name">Plan Name:</label>
                <input type="text" id="plan-name" placeholder="e.g., UTMB_2026" />
            </div>
            <div class="modal-actions">
                <button id="save-confirm-btn" class="btn btn-primary">Save</button>
                <button id="save-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load Plan Modal -->
    <div id="load-modal" class="modal">
        <div class="modal-content">
            <h2>Load Race Plan</h2>
            <div id="plans-list"></div>
            <div class="modal-actions">
                <button id="load-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
