<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Fuel & Pacing Planner</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='fav-icon-circle.png') }}">
    <!-- iOS Home Screen & PWA Meta -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='logo.png') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="RaceCraft">
    <meta name="application-name" content="RaceCraft">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='logo.png') }}">
    <meta name="msapplication-TileColor" content="#2563eb">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ app_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') }}?v={{ app_version }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- App Version for Frontend -->
    <script>
        window.APP_VERSION = '{{ app_version }}';
        window.CLIENT_STORAGE_VERSION = 'v1.6.1'; // Update when localStorage schema changes
    </script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <button id="menu-toggle" class="menu-toggle" aria-label="Toggle menu">
                    <span class="mdi mdi-menu"></span>
                </button>
                <img src="{{ url_for('static', filename='logo-bg-removed.png') }}" alt="RaceCraft Logo" class="header-logo">
                <div class="header-text">
                    <h2 class="subtitle">Fuel & Pacing Planner</h2>
                </div>
                <div class="auth-container" id="auth-container">
                    <!-- Authentication UI will be dynamically populated -->
                </div>
            </div>
        </header>

        <!-- Side Navigation -->
        <nav id="side-nav" class="side-nav">
            <div class="side-nav-header">
                <h3>Navigation</h3>
                <button id="nav-close" class="nav-close" aria-label="Close menu">
                    <span class="mdi mdi-close"></span>
                </button>
            </div>
            <ul class="nav-menu">
                <li><a href="/" class="nav-link active"><span class="mdi mdi-home"></span> Home</a></li>
                <li><a href="/about" class="nav-link"><span class="mdi mdi-information"></span> About</a></li>
                <li><a href="/docs" class="nav-link"><span class="mdi mdi-book-open-variant"></span> Documentation</a></li>
            </ul>
        </nav>

        <!-- Overlay for mobile menu -->
        <div id="nav-overlay" class="nav-overlay"></div>

        <div class="main-grid">
            <!-- Left Panel: Inputs -->
            <div class="panel inputs-panel">
                <h2>Race Configuration</h2>

                <!-- GPX Upload -->
                <section class="input-section">
                    <h3>1. Upload Route (GPX)</h3>
                    <div class="file-upload">
                        <input type="file" id="gpx-file" accept=".gpx" />
                        <label for="gpx-file" class="file-label">
                            <span id="file-name">Choose GPX file...</span>
                        </label>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button id="load-known-race-btn" class="secondary-btn">
                            <span class="mdi mdi-map-marker-multiple"></span> Load Known Race
                        </button>
                    </div>
                    <div id="gpx-info" class="info-box" style="display: none;"></div>
                </section>

                <!-- Checkpoints -->
                <section class="input-section">
                    <h3>2. Checkpoints</h3>
                    <div class="input-group">
                        <label for="num-checkpoints">Number of Checkpoints:</label>
                        <input type="number" id="num-checkpoints" min="0" max="30" value="3" />
                        <span class="checkpoint-counter" id="checkpoint-counter" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
                    </div>
                    <div class="input-group">
                        <label for="avg-cp-time">
                            Avg CP Stop Time (minutes):
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Average time you expect to spend at each checkpoint for refueling, nutrition, and rest. This time is added to your total race time but not included in moving time calculations."></span>
                        </label>
                        <input type="text" id="avg-cp-time" min="0" step="0.5" value="5" pattern="[0-9]*\.?[0-9]*" inputmode="decimal" />
                    </div>
                    <div id="checkpoint-distances"></div>
                </section>

                <!-- Terrain Difficulty -->
                <section class="input-section">
                    <h3>3. Terrain Difficulty</h3>
                    <div class="input-group checkbox-group">
                        <input type="checkbox" id="terrain-enabled" />
                        <label for="terrain-enabled">
                            Include Terrain Difficulty Adjustments
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Adjusts pace based on terrain type (road, trail, technical, etc.). Different terrain types have different speed multipliers. Your technical skill level determines how much these penalties are reduced."></span>
                        </label>
                    </div>
                    <div id="terrain-skill-container" style="display: none;">
                        <div class="input-group">
                            <label for="skill-level">
                                  Technical Skill Level (Terrain Penalty):
                                  <span class="info-icon mdi mdi-information-outline" 
                                      tabindex="0"
                                      data-tooltip="How much extra time you lose on technical terrain. Conservative = 100% of the terrain penalty (full slowdown), Elite = 0% penalty (no slowdown). Higher skill means less penalty. See documentation for details."></span>
                            </label>
                            <select id="skill-level">
                                <option value="0.0" title="Struggles on rough terrain, slow pace">Conservative (slow on rough terrain)</option>
                                <option value="0.25" title="Handles easy trails, slow on technical sections">Moderate (struggles on technical trails)</option>
                                <option value="0.5" selected title="Comfortable on most trails, moderate pace">Strong (handles most trails)</option>
                                <option value="0.75" title="Confident on technical terrain, maintains pace">Very Strong (confident on technical terrain)</option>
                                <option value="1.0" title="Moves efficiently on all terrain, minimal slowdown">Elite (fast on all terrain)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="default-terrain-type">
                                Default Terrain Type:
                                <span class="info-icon mdi mdi-information-outline" 
                                      tabindex="0"
                                      data-tooltip="Sets the terrain type for all segments at once. Each terrain type has a pace multiplier - smoother terrain is faster, technical terrain is slower. You can override individual segments later if needed."></span>
                            </label>
                            <select id="default-terrain-type">
                                <option value="">-- Select to apply to all --</option>
                                <option value="road">Road/Track (0.95Ã—)</option>
                                <option value="smooth_trail" selected>Smooth Trail (1.0Ã—)</option>
                                <option value="dirt_road">Dirt Road (1.05Ã—)</option>
                                <option value="rocky_runnable">Rocky Runnable (1.15Ã—)</option>
                                <option value="technical">Technical Trail (1.33Ã—)</option>
                                <option value="very_technical">Very Technical (1.65Ã—)</option>
                                <option value="scrambling">Scrambling (2.0Ã—)</option>
                            </select>
                        </div>
                        <div id="terrain-difficulties"></div>
                    </div>
                </section>

                <!-- Pacing -->
                <section class="input-section">
                    <h3>4. Pacing</h3>
                    <div class="input-group">
                        <label>
                            Pacing Mode:
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Base Pace: Calculate finish time from your flat terrain pace. Target Time: Enter your goal finish time and calculate required paces for each segment."></span>
                        </label>
                        <div class="pacing-mode-toggle">
                            <label class="radio-label">
                                <input type="radio" name="pacing-mode" id="pacing-mode-base" value="base_pace" checked />
                                <span>Base Pace</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="pacing-mode" id="pacing-mode-target" value="target_time" />
                                <span>Target Time</span>
                            </label>
                        </div>
                    </div>
                    <div id="base-pace-inputs">
                        <div class="input-group">
                            <label for="z2-pace-min">
                                Flat Terrain Pace
                                <span class="info-icon mdi mdi-information-outline" 
                                      tabindex="0"
                                      data-tooltip="Your expected average pace on flat terrain at a comfortable, sustainable effort level (Zone 2). This serves as the baseline for calculating pace adjustments based on elevation changes and terrain difficulty."></span>
                            </label>
                            <div class="pace-input">
                                <input type="number" id="z2-pace-min" min="3" max="20" value="6" pattern="[0-9]*" inputmode="numeric" />
                                <span>:</span>
                                <input type="number" id="z2-pace-sec" min="0" max="59" value="30" pattern="[0-9]*" inputmode="numeric" />
                                <span class="unit">min/km</span>
                            </div>
                        </div>
                    </div>
                    <div id="target-time-inputs" style="display: none;">
                        <div class="input-group">
                            <label for="target-finish-time">
                                Target Finish Time
                                <span class="info-icon mdi mdi-information-outline" 
                                      tabindex="0"
                                      data-tooltip="Your goal total race time including checkpoint stops. The system will calculate required paces for each segment to meet this target, accounting for terrain, elevation, and fatigue."></span>
                            </label>
                            <div class="time-input">
                                <input type="number" id="target-time-hours" min="0" max="99" value="10" placeholder="HH" pattern="[0-9]*" inputmode="numeric" />
                                <span>:</span>
                                <input type="number" id="target-time-minutes" min="0" max="59" value="0" placeholder="MM" pattern="[0-9]*" inputmode="numeric" />
                                <span>:</span>
                                <input type="number" id="target-time-seconds" min="0" max="59" value="0" placeholder="SS" pattern="[0-9]*" inputmode="numeric" />
                            </div>
                            <div id="target-time-warning" class="validation-error" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="input-group" id="climbing-ability-group">
                        <label for="climbing-ability">
                            Climbing Ability:
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Your vertical ascent rate capability. BASE PACE MODE: Determines how much climbing affects your pace on uphills. TARGET TIME MODE: Affects effort cost multipliers - elite climbers find it 'cheaper' to gain time on climbs (0.75x cost) vs conservative climbers (1.2x cost), so optimizer naturally prioritizes climbs for strong climbers."></span>
                        </label>
                        <select id="climbing-ability">
                            <option value="conservative">Conservative Climber (600 m/h)</option>
                            <option value="moderate" selected>Moderate Climber (800 m/h)</option>
                            <option value="strong">Strong Climber (1000 m/h)</option>
                            <option value="very_strong">Very Strong Climber (1250 m/h)</option>
                            <option value="elite">Elite Climber (1500 m/h)</option>
                        </select>
                    </div>
                    <div class="input-group checkbox-group">
                        <input type="checkbox" id="fatigue-enabled" checked />
                        <label for="fatigue-enabled">
                            Include Fatigue Penalty
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="BASE PACE MODE: Your pace gradually slows down as accumulated distance and elevation increase throughout the race. TARGET TIME MODE: Effort cost increases over distance (fatigue multiplier), making optimizer prefer early effort over late effort. Fitness level controls how steep the cost curve is."></span>
                        </label>
                    </div>
                    <div class="input-group" id="fitness-level-group">
                        <label for="fitness-level">
                            Fitness Level:
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="Your endurance fitness level. BASE PACE MODE: Determines Fatigue Onset Point (FOP) - the distance where you start experiencing significant pace degradation. TARGET TIME MODE: Controls global effort budget (15-50% max deviation from natural pace) and fatigue cost curve steepness. Higher fitness allows more aggressive target times."></span>
                        </label>
                        <select id="fitness-level">
                            <option value="untrained">Untrained (FOP: 20-30 km-effort)</option>
                            <option value="recreational" selected>Recreational (FOP: 30-45 km-effort)</option>
                            <option value="trained">Trained (FOP: 45-65 km-effort)</option>
                            <option value="elite">Elite (FOP: 65-85+ km-effort)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="race-start-time">Race Start Time (optional):</label>
                        <input type="time" id="race-start-time" />
                    </div>
                </section>

                <!-- Nutrition -->
                <section class="input-section">
                    <h3>5. Nutrition</h3>
                    <div class="input-group">
                        <label for="carbs-per-hour">Carbs per Hour (g):</label>
                        <input type="text" id="carbs-per-hour" min="0" step="5" value="60" pattern="[0-9]*\.?[0-9]*" inputmode="decimal" />
                    </div>
                    <div class="input-group">
                        <label for="water-per-hour">Water per Hour (mL):</label>
                        <input type="text" id="water-per-hour" min="0" step="50" value="500" pattern="[0-9]*\.?[0-9]*" inputmode="decimal" />
                    </div>
                    <div class="input-group">
                        <label for="carbs-per-serving">
                            Carbs per Serving (g, optional):
                            <span class="info-icon mdi mdi-information-outline" 
                                  tabindex="0"
                                  data-tooltip="If specified, the dropbag table will show how many servings to pack in each dropbag to meet your carb targets. Leave empty to only show total carbs."></span>
                        </label>
                        <input type="text" id="carbs-per-serving" min="0" step="1" placeholder="e.g., 25" pattern="[0-9]*\.?[0-9]*" inputmode="decimal" />
                    </div>
                </section>

                <!-- Actions -->
                <section class="actions">
                    <button id="calculate-btn" class="btn btn-primary">Calculate Race Plan</button>
                    <button id="save-btn" class="btn btn-secondary" disabled>Save Plan</button>
                    <button id="load-btn" class="btn btn-secondary">Load Plan</button>
                    <button id="import-plan-btn-direct" class="btn btn-secondary">Import Plan</button>
                    <input type="file" id="import-plan-file-input" accept=".json" style="display: none;" />
                    <button id="export-btn" class="btn btn-secondary" disabled>Export</button>
                    <button id="clear-btn" class="btn btn-danger">Clear & Start Again</button>
                </section>
            </div>

            <!-- Right Panel: Results -->
            <div class="panel results-panel">
                <h2 id="race-plan-title">Race Plan</h2>
                
                <div id="results-container" style="display: none;">
                    <!-- Elevation Profile -->
                    <div class="elevation-chart-container">
                        <h3>Elevation Profile</h3>
                        <canvas id="elevation-chart"></canvas>
                    </div>
                    
                    <!-- Summary -->
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="card-label">Total Distance</div>
                            <div class="card-value" id="summary-distance">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Moving Time</div>
                            <div class="card-value" id="summary-moving-time">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">CP Time</div>
                            <div class="card-value" id="summary-cp-time">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Total Time</div>
                            <div class="card-value" id="summary-total-time">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Elevation Gain</div>
                            <div class="card-value" id="summary-elev-gain">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Total Carbs</div>
                            <div class="card-value" id="summary-carbs">--</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Total Water</div>
                            <div class="card-value" id="summary-water">--</div>
                        </div>
                    </div>

                    <!-- Target Time Thresholds (shown only in target time mode) -->
                    <div id="effort-thresholds-container" style="display: none; margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <h3 style="margin-top: 0; margin-bottom: 15px; color: #1e293b; font-size: 1.1rem;">
                            <span class="mdi mdi-information-outline"></span> Target Time Guidance
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 4px;">Natural Pace Baseline</div>
                                <div style="font-size: 1.3rem; font-weight: bold; color: #0f172a;" id="threshold-natural">--:--:--</div>
                                <div style="color: #64748b; font-size: 0.75rem; margin-top: 4px;">Your natural pacing</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 4px;">
                                    <span class="effort-badge effort-push" style="font-size: 0.7rem; padding: 2px 6px;">PUSH</span> Threshold
                                </div>
                                <div style="font-size: 1.3rem; font-weight: bold; color: #dc2626;" id="threshold-push">--:--:--</div>
                                <div style="color: #64748b; font-size: 0.75rem; margin-top: 4px;">Most segments require pushing</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 4px;">
                                    <span class="effort-badge effort-protect" style="font-size: 0.7rem; padding: 2px 6px;">Protect</span> Threshold
                                </div>
                                <div style="font-size: 1.3rem; font-weight: bold; color: #16a34a;" id="threshold-protect">--:--:--</div>
                                <div style="color: #64748b; font-size: 0.75rem; margin-top: 4px;">Most segments are protecting</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #eff6ff; border-radius: 4px; font-size: 0.85rem; color: #1e40af;">
                            <strong>ðŸ’¡ How to use:</strong> Target times faster than the Push threshold require aggressive pacing. 
                            Target times between Natural and Push will be mostly steady with some pushing. 
                            Target times slower than Protect threshold allow for conservative pacing with recovery segments.
                        </div>
                    </div>

                    <!-- Segments Table -->
                    <div class="table-container">
                        <table id="segments-table">
                            <thead>
                                <tr>
                                    <th>Segment</th>
                                    <th>Cumul Dist (km)</th>
                                    <th>Elev +/-</th>
                                    <th>Net (m)</th>
                                    <th>Elev Pace</th>
                                    <th class="fatigue-col">Fatigue</th>
                                    <th class="terrain-col">Terrain</th>
                                    <th>Final Pace</th>
                                    <th>Time</th>
                                    <th>Carbs (g)</th>
                                    <th>Water (L)</th>
                                    <th>Cumul Time</th>
                                    <th class="time-of-day-col" id="time-header" style="display: none;">Time of Arrival</th>
                                </tr>
                            </thead>
                            <tbody id="segments-tbody">
                                <!-- Segments will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Drop Bag Table -->
                    <div class="table-container" id="dropbag-table-container" style="display: none;">
                        <h3>Drop Bag Contents for Each CP</h3>
                        <table id="dropbag-table">
                            <thead>
                                <tr>
                                    <th>Checkpoint</th>
                                    <th>Carb Target (g)</th>
                                    <th>Hydration Target (L)</th>
                                </tr>
                            </thead>
                            <tbody id="dropbag-tbody">
                                <!-- Dropbag contents will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="no-results" class="placeholder">
                    <p>ðŸ‘† Configure your race and click "Calculate Race Plan" to see results</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Plan Modal -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h2>Save Race Plan</h2>
            <div class="input-group">
                <label for="plan-name">Plan Name:</label>
                <input type="text" id="plan-name" placeholder="e.g., UTMB_2026" />
            </div>
            <div class="modal-actions">
                <button id="save-confirm-btn" class="btn btn-primary">Save</button>
                <button id="save-as-btn" class="btn btn-primary" style="display: none;">Save As</button>
                <button id="save-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load Plan Modal -->
    <div id="load-modal" class="modal">
        <div class="modal-content">
            <h2>Load Race Plan</h2>
            <div id="plans-list"></div>
            <div class="modal-actions">
                <button id="import-unowned-plans-btn" class="btn btn-primary">Import Local & Unowned Plans</button>
                <button id="load-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load Known Race Modal -->
    <div id="known-race-modal" class="modal">
        <div class="modal-content">
            <h2>Load Known Race</h2>
            <div class="input-group">
                <label for="known-race-search">Search:</label>
                <input type="text" id="known-race-search" placeholder="Search by race name, organiser, or year..." />
            </div>
            <div id="known-races-list" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                <!-- Known races will be populated here -->
            </div>
            <div class="modal-actions">
                <button id="known-race-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div id="export-options-modal" class="modal">
        <div class="modal-content">
            <h2>Export Options</h2>
            <p class="info-text">Choose how you want to export your race plan:</p>
            <div class="export-options">
                <button id="export-pdf-btn" class="btn btn-primary" style="width: 100%; margin: 10px 0;">
                    <span class="mdi mdi-file-pdf-box"></span> Export to PDF (Configurable)
                </button>
                <button id="export-backup-btn" class="btn btn-primary" style="width: 100%; margin: 10px 0;">
                    <span class="mdi mdi-download"></span> Backup File (Re-importable)
                </button>
                <button id="export-csv-btn" class="btn btn-primary" style="width: 100%; margin: 10px 0;">
                    <span class="mdi mdi-file-delimited"></span> CSV Export
                </button>
            </div>
            <div class="modal-actions">
                <button id="export-options-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PDF Export Options Modal -->
    <div id="pdf-options-modal" class="modal">
        <div class="modal-content">
            <h2>PDF Export Options</h2>
            <p class="info-text">Select which sections to include in your PDF:</p>
            
            <div class="pdf-options">
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="pdf-include-elevation" checked>
                        <span>Elevation Profile Image</span>
                    </label>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="pdf-include-race-plan" checked>
                        <span>Race Plan Table</span>
                    </label>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="pdf-include-dropbags" checked>
                        <span>Drop Bag Table</span>
                    </label>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="pdf-include-tags">
                        <span>Drop Bag Tags (Printable Labels)</span>
                    </label>
                </div>
            </div>

            <div id="pdf-tag-options" style="display: none; margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 5px;">
                <h4 style="margin-top: 0;">Drop Bag Tag Information</h4>
                <div class="input-group">
                    <label for="pdf-race-name">Race Name:</label>
                    <input type="text" id="pdf-race-name" placeholder="e.g., UTMB 100K" />
                </div>
                <div class="input-group">
                    <label for="pdf-bib-number">Bib Number (optional):</label>
                    <input type="text" id="pdf-bib-number" placeholder="123" />
                </div>
                <div class="input-group">
                    <label for="pdf-runner-name">Runner Name (optional):</label>
                    <input type="text" id="pdf-runner-name" placeholder="Your Name" />
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button id="pdf-generate-btn" class="btn btn-primary">Generate PDF</button>
                <button id="pdf-options-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <h2 id="auth-modal-title">Sign In</h2>
            
            <div id="auth-tabs" class="auth-tabs">
                <button class="auth-tab active" data-tab="signin">Sign In</button>
                <button class="auth-tab" data-tab="signup">Sign Up</button>
                <button class="auth-tab" data-tab="magic">Magic Link</button>
            </div>

            <!-- Sign In Form -->
            <div id="signin-form" class="auth-form active">
                <div class="input-group">
                    <label for="signin-email">Email:</label>
                    <input type="email" id="signin-email" placeholder="your@email.com" required />
                </div>
                <div class="input-group">
                    <label for="signin-password">Password:</label>
                    <input type="password" id="signin-password" placeholder="Enter your password" required />
                </div>
                <div id="signin-error" class="error-message" style="display: none;"></div>
                <div class="modal-actions">
                    <button id="signin-btn" class="btn btn-primary">Sign In</button>
                    <button id="auth-cancel-btn-signin" class="btn btn-secondary">Cancel</button>
                </div>
            </div>

            <!-- Sign Up Form -->
            <div id="signup-form" class="auth-form">
                <div class="input-group">
                    <label for="signup-email">Email:</label>
                    <input type="email" id="signup-email" placeholder="your@email.com" required />
                </div>
                <div class="input-group">
                    <label for="signup-password">Password:</label>
                    <input type="password" id="signup-password" placeholder="Choose a password (min 6 characters)" required />
                </div>
                <div class="input-group">
                    <label for="signup-password-confirm">Confirm Password:</label>
                    <input type="password" id="signup-password-confirm" placeholder="Confirm your password" required />
                </div>
                <div id="signup-error" class="error-message" style="display: none;"></div>
                <div id="signup-success" class="success-message" style="display: none;">
                    Account created successfully! Your existing plans have been saved to your account.
                </div>
                <div class="modal-actions">
                    <button id="signup-btn" class="btn btn-primary">Sign Up</button>
                    <button id="auth-cancel-btn-signup" class="btn btn-secondary">Cancel</button>
                </div>
            </div>

            <!-- Magic Link Form -->
            <div id="magic-form" class="auth-form">
                <div class="input-group">
                    <label for="magic-email">Email:</label>
                    <input type="email" id="magic-email" placeholder="your@email.com" required />
                </div>
                <p class="info-text">We'll send you a magic link to sign in without a password.</p>
                <div id="magic-error" class="error-message" style="display: none;"></div>
                <div id="magic-success" class="success-message" style="display: none;">
                    Check your email for a magic link to sign in!
                </div>
                <div class="modal-actions">
                    <button id="magic-btn" class="btn btn-primary">Send Magic Link</button>
                    <button id="auth-cancel-btn-magic" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Migration Selection Modal -->
    <div id="migration-modal" class="modal">
        <div class="modal-content">
            <h2>Import Your Saved Plans?</h2>
            <p class="info-text">You have some race plans saved from before. Would you like to import them into your new account?</p>
            
            <div id="migration-plans-list" class="migration-plans-list">
                <!-- Plans will be populated here -->
            </div>
            
            <div class="modal-actions">
                <button id="migration-import-btn" class="btn btn-primary">Import Selected</button>
                <button id="migration-skip-btn" class="btn btn-secondary">Skip</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/navigation.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}?v={{ app_version }}"></script>
</body>
</html>
