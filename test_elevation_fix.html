<!DOCTYPE html>
<html>
<head>
    <title>Elevation Profile X-Axis Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        .pass { color: green; }
        .fail { color: red; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>Elevation Profile X-Axis Fix - Test Results</h1>
    
    <div class="test-section">
        <h3>Test 1: Data Format Change</h3>
        <p><strong>OLD Format (Array Indices):</strong></p>
        <pre>data: {
    labels: elevationProfile.map(p => p.distance.toFixed(1)),
    datasets: [{
        data: elevationProfile.map(p => p.elevation)
    }]
}</pre>
        <p><strong>NEW Format (Distance-based):</strong></p>
        <pre>data: {
    datasets: [{
        data: elevationProfile.map(p => ({ x: p.distance, y: p.elevation }))
    }]
}</pre>
        <p class="pass">✓ Changed from labels+data array to x/y coordinate pairs</p>
    </div>

    <div class="test-section">
        <h3>Test 2: X-Axis Scale Configuration</h3>
        <p><strong>OLD Configuration (Categorical/Index-based):</strong></p>
        <pre>x: {
    ticks: {
        maxTicksLimit: 15,
        callback: function(value, index) {
            const step = Math.ceil(elevationProfile.length / 15);
            return index % step === 0 ? this.getLabelForValue(value) : '';
        }
    }
}</pre>
        <p><strong>NEW Configuration (Linear Distance-based):</strong></p>
        <pre>x: {
    type: 'linear',
    ticks: {
        callback: function(value) {
            return value.toFixed(1);
        },
        autoSkip: true,
        maxTicksLimit: 15,
        stepSize: (function() {
            const totalDistance = elevationProfile[elevationProfile.length - 1].distance;
            if (totalDistance <= 10) return 1;
            if (totalDistance <= 30) return 2;
            if (totalDistance <= 50) return 5;
            if (totalDistance <= 100) return 10;
            if (totalDistance <= 200) return 20;
            return 25;
        })()
    }
}</pre>
        <p class="pass">✓ Added type: 'linear' for true distance-based scaling</p>
        <p class="pass">✓ Implemented dynamic stepSize based on total distance</p>
        <p class="pass">✓ Removed index-based tick callback logic</p>
    </div>

    <div class="test-section">
        <h3>Test 3: Checkpoint Line Positioning</h3>
        <p><strong>OLD Method (Find Closest Index):</strong></p>
        <pre>// Find the closest index in elevation profile to this checkpoint distance
let closestIndex = 0;
let minDiff = Math.abs(elevationProfile[0].distance - cp.distance);
for (let i = 1; i < elevationProfile.length; i++) {
    const diff = Math.abs(elevationProfile[i].distance - cp.distance);
    if (diff < minDiff) {
        minDiff = diff;
        closestIndex = i;
    }
}
// Get pixel position using the index
const xPos = x.getPixelForValue(closestIndex);</pre>
        <p><strong>NEW Method (Direct Distance Lookup):</strong></p>
        <pre>// Get pixel position using the distance value directly
const xPos = x.getPixelForValue(cp.distance);</pre>
        <p class="pass">✓ Simplified from 10+ lines to 1 line</p>
        <p class="pass">✓ Uses distance value directly instead of array index</p>
        <p class="pass">✓ Checkpoint lines will now align with true distance positions</p>
    </div>

    <div class="test-section">
        <h3>Test 4: Tooltip Updates</h3>
        <p><strong>OLD Method:</strong></p>
        <pre>title: (context) => {
    const distance = parseFloat(context[0].label);
    // ...
}
label: (context) => {
    const distance = parseFloat(context.label);
    // ...
}</pre>
        <p><strong>NEW Method:</strong></p>
        <pre>title: (context) => {
    const distance = context[0].parsed.x;
    // ...
}
label: (context) => {
    const distance = context.parsed.x;
    // ...
}</pre>
        <p class="pass">✓ Tooltips now read distance from parsed.x coordinate</p>
        <p class="pass">✓ Eliminates parseFloat conversion</p>
    </div>

    <div class="test-section">
        <h3>Test 5: Dynamic Step Size Calculation</h3>
        <table border="1" cellpadding="5" cellspacing="0">
            <thead>
                <tr>
                    <th>Total Distance</th>
                    <th>Step Size (km)</th>
                    <th>Tick Count (approx)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>10 km</td>
                    <td>1 km</td>
                    <td>~10 ticks</td>
                </tr>
                <tr>
                    <td>30 km</td>
                    <td>2 km</td>
                    <td>~15 ticks</td>
                </tr>
                <tr>
                    <td>50 km</td>
                    <td>5 km</td>
                    <td>~10 ticks</td>
                </tr>
                <tr>
                    <td>102 km</td>
                    <td>10 km</td>
                    <td>~10 ticks</td>
                </tr>
                <tr>
                    <td>200 km</td>
                    <td>20 km</td>
                    <td>~10 ticks</td>
                </tr>
                <tr>
                    <td>250+ km</td>
                    <td>25 km</td>
                    <td>~10 ticks</td>
                </tr>
            </tbody>
        </table>
        <p class="pass">✓ Adaptive tick intervals based on route distance</p>
        <p class="pass">✓ Maintains readability across different race distances</p>
    </div>

    <div class="test-section">
        <h3>Summary of Changes</h3>
        <ul>
            <li class="pass">✓ X-axis now uses actual distance values (not array indices)</li>
            <li class="pass">✓ Linear scale type ensures proportional distance representation</li>
            <li class="pass">✓ Dynamic tick intervals adapt to route distance and plot width</li>
            <li class="pass">✓ Checkpoint lines positioned using distance values</li>
            <li class="pass">✓ Tooltips updated to read from coordinate data</li>
            <li class="pass">✓ Visual distortion from GPX sampling density eliminated</li>
        </ul>
        
        <h4>Expected Behavior:</h4>
        <ul>
            <li>On a 102 km route, the 50 km point will appear at approximately 50% across the plot (not ~25%)</li>
            <li>Sections with dense GPX sampling will no longer visually stretch</li>
            <li>Sections with sparse GPX sampling will no longer visually compress</li>
            <li>The elevation profile accurately represents the route's distance-elevation relationship</li>
        </ul>
    </div>
</body>
</html>
